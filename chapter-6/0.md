# 第6章 Hiveql:查询


## 6.1 select...from语句

有如下表结构:

```
CREATE TABLE employees (
name STRING,
salary FLOAT,
subordinates ARRAY<STRING>,
deductions MAP<STRING, FLOAT>,
address STRUCT<street:STRING, city:STRING, state:STRING, zip:INT>
)
PARTITIONED BY (country STRING, state STRING);
```

```
hive> SELECT name, salary FROM employees;
John Doe 100000.0
Mary Smith 80000.0
Todd Jones 70000.0
Bill King 60000.0
```

为表指定别名

```
hive> SELECT e.name, e.salary FROM employees e;
```

* 查询列类型为数组,其值使用```JSON```语法输出，其值使用一个被括在```[]```内以逗号分隔的列表进行表示。集合的字符串元素是加引号表示的。基本数据类型```STRING```的列值是不加引号的。如下所示:

```
hive> SELECT name, subordinates FROM employees;
John Doe ["Mary Smith","Todd Jones"]
Mary Smith ["Bill King"]
Todd Jones []
Bill King []
```

* 查询列类型为```MAP```，其值使用```JSON```格式来表示。即用一个被括在```{}```内以逗号分隔的键值对列表。如下所示:

```
hive> SELECT name, deductions FROM employees;
John Doe {"Federal Taxes":0.2,"State Taxes":0.05,"Insurance":0.1}
Mary Smith {"Federal Taxes":0.2,"State Taxes":0.05,"Insurance":0.1}
Todd Jones {"Federal Taxes":0.15,"State Taxes":0.03,"Insurance":0.1}
Bill King {"Federal Taxes":0.15,"State Taxes":0.03,"Insurance":0.1}
```

* 查询列类型为```STRUCT```，其值也是使用```JSON```格式来表示。如下所示:

```
hive> SELECT name, address FROM employees;
John Doe {"street":"1 Michigan Ave.","city":"Chicago","state":"IL","zip":60600}
Mary Smith {"street":"100 Ontario St.","city":"Chicago","state":"IL","zip":60601}
Todd Jones {"street":"200 Chicago Ave.","city":"Oak Park","state":"IL","zip":60700}
Bill King {"street":"300 Obscure Dr.","city":"Obscuria","state":"IL","zip":60100}
```

数组索引是从```0```开始的，查询数组中第一个元素的例子:

```
hive> SELECT name, subordinates[0] FROM employees;
John Doe Mary Smith
Mary Smith Bill King
Todd Jones NULL
Bill King NULL
```

注意:查询一个不存在元素将会返回```NULL```。

查询一个```MAP```元素，使用```ARRAY[]```语法，但是使用的是键值而不是数组下标索引。如:

```
hive> SELECT name, deductions["State Taxes"] FROM employees;
John Doe 0.05
Mary Smith 0.05
Todd Jones 0.03
Bill King 0.03
```

查询```STRUCT```中的元素使用```.```(点)符号.类似于表的别名.列名。如:

```
hive> SELECT name, address.city FROM employees;
John Doe Chicago
Mary Smith Chicago
Todd Jones Oak Park
Bill King Obscuria
```


### 6.1.1 使用正则表达式来指定列

```
hive> SELECT symbol, `price.*` FROM stocks;
AAPL 195.69 197.88 194.0 194.12 194.12
AAPL 192.63 196.0 190.85 195.46 195.46
AAPL 196.73 198.37 191.57 192.05 192.05
AAPL 195.17 200.2 194.42 199.23 199.23
AAPL 195.91 196.32 193.38 195.86 195.86
```

### 6.1.2 使用列值进行计算

```
hive > SELECT upper(name), salary, deductions["Federal Taxes"],
     > round(salary * (1 - deductions["Federal Taxes"])) FROM employees;
JOHN DOE 100000.0 0.2 80000
MARY SMITH 80000.0 0.2 64000
TODD JONES 70000.0 0.15 59500
BILL KING 60000.0 0.15 51000
```

### 6.1.3 算术运算符

```
A + B	Numbers		Add A and B.
A - B	Numbers		Subtract B from A.
A * B	Numbers		Multiply A and B.
A / B	Numbers		Divide A with B. If the operands are integer types, the quotient of the divisionis returned.
A % B	Numbers		The remainder of dividing A with B.
A & B	Numbers		Bitwise AND of A and B.
A | B	Numbers		Bitwise OR of A and B.
A ^ B	Numbers		Bitwise XOR of A and B.
~A	Numbers		Bitwise NOT of A.
```


### 6.1.4 使用函数

1. 数学函数




### 6.1.5 limit语句


### 6.1.6 列别名


### 6.1.7 嵌套select语句


### 6.1.8 case...when...then 句式


### 6.1.9 什么情况下hive可以避免进行mapreduce


## 6.2 where语句


### 6.2.1 谓词操作符


### 6.2.2 关于浮点数比较


### 6.2.3 like和rlike


## 6.3 group by 语句


## 6.4 join语句


### 6.4.1 inner join


### 6.4.2 join优化


### 6.4.3 left outer join


### 6.4.4 outer join


### 6.4.5 right outer join


### 6.4.6 full outer join


### 6.4.7 left semi-join


### 6.4.8 笛卡尔积join


### 6.4.9 map-side join


## 6.5 order by和sort by


## 6.6 含有sort by 的distribute by


## 6.7 cluster by


## 6.8 类型转换


## 6.9 抽样查询


### 6.9.1 数据块抽样


### 6.9.2 分桶表的输入裁剪


## 6.10 union all