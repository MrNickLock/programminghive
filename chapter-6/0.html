<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head prefix="og: http://ogp.me/ns# book: http://ogp.me/ns/book#">
        
        
        <meta charset="UTF-8">
        <title>第六章 HiveQL:查询 | Programming Hive 读书笔记</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="robots" content="index, follow">
        <meta name="author" content="sxyx2008">
        <meta name="description" content="Book generated using GitBook">
        <meta name="keywords" content="gitbook,github" >
        <meta name="generator" content="www.gitbook.io">

        
        <link rel="next" href="../chapter-7/0.html" />
        
        
        <link rel="prev" href="../chapter-5/0.html" />
        

        <meta property="og:title" content="第六章 HiveQL:查询 | Programming Hive 读书笔记">
        <meta property="og:site_name" content="Programming Hive 读书笔记">
        <meta property="og:type" content="book">
        <meta property="og:locale" content="en_US">

        <meta property="book:author" content="https://github.com/sxyx2008">
        <meta property="book:tag" content="GitBook">

        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="shortcut icon" href="..\gitbook/images/favicon.ico" type="image/x-icon">
        
        
    </head>
    <body>
        
        

        <link rel="stylesheet" href="..\gitbook/style.css">
        


        
    <div class="book" data-github="sxyx2008/programminghive" data-level="7" data-basepath=".." data-revision="1401357905673">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="https://github.com/sxyx2008/programminghive" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    
    <a href="https://github.com/sxyx2008/programminghive/stargazers" target="_blank" class="btn pull-right count-star hidden-xs"><i class="fa fa-star-o"></i> Star (<span>-</span>)</a>
    <a href="https://github.com/sxyx2008/programminghive/watchers" target="_blank" class="btn pull-right count-watch hidden-xs"><i class="fa fa-eye"></i> Watch (<span>-</span>)</a>
    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="../" >Programming Hive 读书笔记</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        <li>
            <a href="https://github.com/sxyx2008" target="blank" class="author-link">About the author</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/sxyx2008/programminghive/issues" target="blank"class="issues-link">Questions and Issues</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/sxyx2008/programminghive/edit/master/chapter-6/0.md" target="blank" class="contribute-link">Edit and Contribute</a>
        </li>
        

        
        <li class="divider"></li>
        

        <li data-level="0" data-path="index.html">
            <a href="../"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
    
        <li class="chapter " data-level="1" data-path="index.html">
            
            <a href="../index.html">
                <i class="fa fa-check"></i> <b>1.</b> README
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="chapter-1/0.html">
            
            <a href="../chapter-1/0.html">
                <i class="fa fa-check"></i> <b>2.</b> 第一章 基础知识
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="chapter-2/0.html">
            
            <a href="../chapter-2/0.html">
                <i class="fa fa-check"></i> <b>3.</b> 第二章 基础操作
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="chapter-3/0.html">
            
            <a href="../chapter-3/0.html">
                <i class="fa fa-check"></i> <b>4.</b> 第三章 数据类型和文件格式
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="chapter-4/0.html">
            
            <a href="../chapter-4/0.html">
                <i class="fa fa-check"></i> <b>5.</b> 第四章 HiveQL:数据定义
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="chapter-5/0.html">
            
            <a href="../chapter-5/0.html">
                <i class="fa fa-check"></i> <b>6.</b> 第五章 HiveQL:数据操作
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="chapter-6/0.html">
            
            <a href="../chapter-6/0.html">
                <i class="fa fa-check"></i> <b>7.</b> 第六章 HiveQL:查询
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="chapter-7/0.html">
            
            <a href="../chapter-7/0.html">
                <i class="fa fa-check"></i> <b>8.</b> 第七章 HiveQL:视图
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="chapter-8/0.html">
            
            <a href="../chapter-8/0.html">
                <i class="fa fa-check"></i> <b>9.</b> 第八章 HiveQL:索引
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="chapter-9/0.html">
            
            <a href="../chapter-9/0.html">
                <i class="fa fa-check"></i> <b>10.</b> 第九章 模式设计
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="11" data-path="chapter-10/0.html">
            
            <a href="../chapter-10/0.html">
                <i class="fa fa-check"></i> <b>11.</b> 第十章 调优
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="chapter-11/0.html">
            
            <a href="../chapter-11/0.html">
                <i class="fa fa-check"></i> <b>12.</b> 第十一章 其他文件格式和压缩方法
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="chapter-12/0.html">
            
            <a href="../chapter-12/0.html">
                <i class="fa fa-check"></i> <b>13.</b> 第十二章 开发
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="chapter-13/0.html">
            
            <a href="../chapter-13/0.html">
                <i class="fa fa-check"></i> <b>14.</b> 第十三章 函数
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="chapter-14/0.html">
            
            <a href="../chapter-14/0.html">
                <i class="fa fa-check"></i> <b>15.</b> 第十四章 Streaming
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="chapter-15/0.html">
            
            <a href="../chapter-15/0.html">
                <i class="fa fa-check"></i> <b>16.</b> 第十五章 自定义Hive文件和记录格式
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="chapter-16/0.html">
            
            <a href="../chapter-16/0.html">
                <i class="fa fa-check"></i> <b>17.</b> 第十六章 Hive的Thrift服务
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="chapter-17/0.html">
            
            <a href="../chapter-17/0.html">
                <i class="fa fa-check"></i> <b>18.</b> 第十七章 存储处理程序和NoSQL
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="chapter-18/0.html">
            
            <a href="../chapter-18/0.html">
                <i class="fa fa-check"></i> <b>19.</b> 第十八章 安全
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="chapter-19/0.html">
            
            <a href="../chapter-19/0.html">
                <i class="fa fa-check"></i> <b>20.</b> 第十九章 锁
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="chapter-20/0.html">
            
            <a href="../chapter-20/0.html">
                <i class="fa fa-check"></i> <b>21.</b> 第二十章 Hive和Oozie整合
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="chapter-21/0.html">
            
            <a href="../chapter-21/0.html">
                <i class="fa fa-check"></i> <b>22.</b> 第二十一章 Hive和亚马逊网络服务系统(AWS)
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="chapter-22/0.html">
            
            <a href="../chapter-22/0.html">
                <i class="fa fa-check"></i> <b>23.</b> 第二十二章 HCatalog
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="24" data-path="chapter-23/0.html">
            
            <a href="../chapter-23/0.html">
                <i class="fa fa-check"></i> <b>24.</b> 第二十三章 案例研究
            </a>
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 26.08695652173913%;min-width: 21.73913043478261%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../index.html" title="README" class="chapter done new-chapter" data-progress="1" style="left: 0%;"></a>
    
        <a href="../chapter-1/0.html" title="第一章 基础知识" class="chapter done new-chapter" data-progress="2" style="left: 4.3478260869565215%;"></a>
    
        <a href="../chapter-2/0.html" title="第二章 基础操作" class="chapter done new-chapter" data-progress="3" style="left: 8.695652173913043%;"></a>
    
        <a href="../chapter-3/0.html" title="第三章 数据类型和文件格式" class="chapter done new-chapter" data-progress="4" style="left: 13.043478260869565%;"></a>
    
        <a href="../chapter-4/0.html" title="第四章 HiveQL:数据定义" class="chapter done new-chapter" data-progress="5" style="left: 17.391304347826086%;"></a>
    
        <a href="../chapter-5/0.html" title="第五章 HiveQL:数据操作" class="chapter done new-chapter" data-progress="6" style="left: 21.73913043478261%;"></a>
    
        <a href="../chapter-6/0.html" title="第六章 HiveQL:查询" class="chapter done new-chapter" data-progress="7" style="left: 26.08695652173913%;"></a>
    
        <a href="../chapter-7/0.html" title="第七章 HiveQL:视图" class="chapter  new-chapter" data-progress="8" style="left: 30.434782608695652%;"></a>
    
        <a href="../chapter-8/0.html" title="第八章 HiveQL:索引" class="chapter  new-chapter" data-progress="9" style="left: 34.78260869565217%;"></a>
    
        <a href="../chapter-9/0.html" title="第九章 模式设计" class="chapter  " data-progress="10" style="left: 39.130434782608695%;"></a>
    
        <a href="../chapter-10/0.html" title="第十章 调优" class="chapter  " data-progress="11" style="left: 43.47826086956522%;"></a>
    
        <a href="../chapter-11/0.html" title="第十一章 其他文件格式和压缩方法" class="chapter  " data-progress="12" style="left: 47.82608695652174%;"></a>
    
        <a href="../chapter-12/0.html" title="第十二章 开发" class="chapter  " data-progress="13" style="left: 52.17391304347826%;"></a>
    
        <a href="../chapter-13/0.html" title="第十三章 函数" class="chapter  " data-progress="14" style="left: 56.52173913043478%;"></a>
    
        <a href="../chapter-14/0.html" title="第十四章 Streaming" class="chapter  " data-progress="15" style="left: 60.869565217391305%;"></a>
    
        <a href="../chapter-15/0.html" title="第十五章 自定义Hive文件和记录格式" class="chapter  " data-progress="16" style="left: 65.21739130434783%;"></a>
    
        <a href="../chapter-16/0.html" title="第十六章 Hive的Thrift服务" class="chapter  " data-progress="17" style="left: 69.56521739130434%;"></a>
    
        <a href="../chapter-17/0.html" title="第十七章 存储处理程序和NoSQL" class="chapter  " data-progress="18" style="left: 73.91304347826087%;"></a>
    
        <a href="../chapter-18/0.html" title="第十八章 安全" class="chapter  " data-progress="19" style="left: 78.26086956521739%;"></a>
    
        <a href="../chapter-19/0.html" title="第十九章 锁" class="chapter  " data-progress="20" style="left: 82.6086956521739%;"></a>
    
        <a href="../chapter-20/0.html" title="第二十章 Hive和Oozie整合" class="chapter  " data-progress="21" style="left: 86.95652173913044%;"></a>
    
        <a href="../chapter-21/0.html" title="第二十一章 Hive和亚马逊网络服务系统(AWS)" class="chapter  " data-progress="22" style="left: 91.30434782608695%;"></a>
    
        <a href="../chapter-22/0.html" title="第二十二章 HCatalog" class="chapter  " data-progress="23" style="left: 95.65217391304348%;"></a>
    
        <a href="../chapter-23/0.html" title="第二十三章 案例研究" class="chapter  " data-progress="24" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_20">
                    
                        <h1 id="-hiveql-">第六章 HiveQL:查询</h1>
<h2 id="6-1-select-from-">6.1 select...from语句</h2>
<p>有如下表结构:</p>
<pre><code>CREATE TABLE employees (
name STRING,
salary FLOAT,
subordinates ARRAY&lt;STRING&gt;,
deductions MAP&lt;STRING, FLOAT&gt;,
address STRUCT&lt;street:STRING, city:STRING, state:STRING, zip:INT&gt;
)
PARTITIONED BY (country STRING, state STRING);
</code></pre><pre><code>hive&gt; SELECT name, salary FROM employees;
John Doe 100000.0
Mary Smith 80000.0
Todd Jones 70000.0
Bill King 60000.0
</code></pre><p>为表指定别名</p>
<pre><code>hive&gt; SELECT e.name, e.salary FROM employees e;
</code></pre><ul>
<li>查询列类型为数组,其值使用<code>JSON</code>语法输出，其值使用一个被括在<code>[]</code>内以逗号分隔的列表进行表示。集合的字符串元素是加引号表示的。基本数据类型<code>STRING</code>的列值是不加引号的。如下所示:</li>
</ul>
<pre><code>hive&gt; SELECT name, subordinates FROM employees;
John Doe [&quot;Mary Smith&quot;,&quot;Todd Jones&quot;]
Mary Smith [&quot;Bill King&quot;]
Todd Jones []
Bill King []
</code></pre><ul>
<li>查询列类型为<code>MAP</code>，其值使用<code>JSON</code>格式来表示。即用一个被括在<code>{}</code>内以逗号分隔的键值对列表。如下所示:</li>
</ul>
<pre><code>hive&gt; SELECT name, deductions FROM employees;
John Doe {&quot;Federal Taxes&quot;:0.2,&quot;State Taxes&quot;:0.05,&quot;Insurance&quot;:0.1}
Mary Smith {&quot;Federal Taxes&quot;:0.2,&quot;State Taxes&quot;:0.05,&quot;Insurance&quot;:0.1}
Todd Jones {&quot;Federal Taxes&quot;:0.15,&quot;State Taxes&quot;:0.03,&quot;Insurance&quot;:0.1}
Bill King {&quot;Federal Taxes&quot;:0.15,&quot;State Taxes&quot;:0.03,&quot;Insurance&quot;:0.1}
</code></pre><ul>
<li>查询列类型为<code>STRUCT</code>，其值也是使用<code>JSON</code>格式来表示。如下所示:</li>
</ul>
<pre><code>hive&gt; SELECT name, address FROM employees;
John Doe {&quot;street&quot;:&quot;1 Michigan Ave.&quot;,&quot;city&quot;:&quot;Chicago&quot;,&quot;state&quot;:&quot;IL&quot;,&quot;zip&quot;:60600}
Mary Smith {&quot;street&quot;:&quot;100 Ontario St.&quot;,&quot;city&quot;:&quot;Chicago&quot;,&quot;state&quot;:&quot;IL&quot;,&quot;zip&quot;:60601}
Todd Jones {&quot;street&quot;:&quot;200 Chicago Ave.&quot;,&quot;city&quot;:&quot;Oak Park&quot;,&quot;state&quot;:&quot;IL&quot;,&quot;zip&quot;:60700}
Bill King {&quot;street&quot;:&quot;300 Obscure Dr.&quot;,&quot;city&quot;:&quot;Obscuria&quot;,&quot;state&quot;:&quot;IL&quot;,&quot;zip&quot;:60100}
</code></pre><p>数组索引是从<code>0</code>开始的，查询数组中第一个元素的例子:</p>
<pre><code>hive&gt; SELECT name, subordinates[0] FROM employees;
John Doe Mary Smith
Mary Smith Bill King
Todd Jones NULL
Bill King NULL
</code></pre><p>注意:查询一个不存在元素将会返回<code>NULL</code>。</p>
<p>查询一个<code>MAP</code>元素，使用<code>ARRAY[]</code>语法，但是使用的是键值而不是数组下标索引。如:</p>
<pre><code>hive&gt; SELECT name, deductions[&quot;State Taxes&quot;] FROM employees;
John Doe 0.05
Mary Smith 0.05
Todd Jones 0.03
Bill King 0.03
</code></pre><p>查询<code>STRUCT</code>中的元素使用<code>.</code>(点)符号.类似于表的别名.列名。如:</p>
<pre><code>hive&gt; SELECT name, address.city FROM employees;
John Doe Chicago
Mary Smith Chicago
Todd Jones Oak Park
Bill King Obscuria
</code></pre><h3 id="6-1-1-">6.1.1 使用正则表达式来指定列</h3>
<pre><code>hive&gt; SELECT symbol, `price.*` FROM stocks;
AAPL 195.69 197.88 194.0 194.12 194.12
AAPL 192.63 196.0 190.85 195.46 195.46
AAPL 196.73 198.37 191.57 192.05 192.05
AAPL 195.17 200.2 194.42 199.23 199.23
AAPL 195.91 196.32 193.38 195.86 195.86
</code></pre><h3 id="6-1-2-">6.1.2 使用列值进行计算</h3>
<pre><code>hive &gt; SELECT upper(name), salary, deductions[&quot;Federal Taxes&quot;],
     &gt; round(salary * (1 - deductions[&quot;Federal Taxes&quot;])) FROM employees;
JOHN DOE 100000.0 0.2 80000
MARY SMITH 80000.0 0.2 64000
TODD JONES 70000.0 0.15 59500
BILL KING 60000.0 0.15 51000
</code></pre><h3 id="6-1-3-">6.1.3 算术运算符</h3>
<pre><code>A + B    Numbers
A - B    Numbers
A * B    Numbers
A / B    Numbers
A % B    Numbers
A &amp; B    Numbers
A | B    Numbers
A ^ B    Numbers
~A    Numbers
</code></pre><h3 id="6-1-4-">6.1.4 使用函数</h3>
<ul>
<li>数学函数</li>
</ul>
<pre><code>BIGINT        round(d)            
DOUBLE        round(d, N)            
BIGINT        floor(d)            
BIGINT        ceil(d),ceiling(DOUBLE d)    
DOUBLE        rand(), rand(seed)        
DOUBLE        exp(d)                
DOUBLE        ln(d)                
DOUBLE        log10(d)            
DOUBLE        log2(d)                
DOUBLE        log(base, d)            
DOUBLE        pow(d, p), power(d, p)        
DOUBLE        sqrt(d)                
STRING        bin(i)                
STRING        hex(i)                
STRING        hex(str)            
STRING        unhex(i)            
STRING        conv(i, from_base, to_base)    
STRING        conv(str, from_base,to_base)    
DOUBLE        abs(d)                
INT        pmod(i1, i2)            
DOUBLE        pmod(d1, d2)            
DOUBLE        sin(d)                
DOUBLE        asin(d)                
DOUBLE        cos(d)                
DOUBLE        acos(d)                
DOUBLE        tan(d)                
DOUBLE        atan(d)                
DOUBLE        degrees(d)            
DOUBLE        radians(d)            
INT        positive(i)            
DOUBLE        positive(d)            
INT        negative(i)            
DOUBLE        negative(d)            
FLOAT        sign(d)                
DOUBLE        e()                
DOUBLE        pi()
</code></pre><ul>
<li>聚合函数</li>
</ul>
<pre><code>BIGINT        count(*)            
BIGINT        count(expr)            
BIGINT        count(DISTINCT expr[, expr_.])    
DOUBLE        sum(col)            
DOUBLE        sum(DISTINCT col)        
DOUBLE        avg(col)            
DOUBLE        avg(DISTINCT col)        
DOUBLE        min(col)            
DOUBLE        max(col)            
DOUBLE        variance(col),var_pop(col)    
DOUBLE        var_samp(col)            
DOUBLE        stddev_pop(col)            
DOUBLE        stddev_samp(col)        
DOUBLE        covar_pop(col1, col2)        
DOUBLE        covar_samp(col1, col2)        
DOUBLE        corr(col1, col2)        
DOUBLE        percentile(int_expr, p)        
ARRAY&lt;DOUBLE&gt;    percentile(int_expr,[p1, ...])    
DOUBLE        percentile_approx(int_expr,p , NB)    
DOUBLE        percentile_approx(int_expr,[p1, ...] , NB)    
ARRAY&lt;STRUCT{&#39;x&#39;,&#39;y&#39;}&gt;    histogram_numeric(col, NB)    
ARRAY        collect_set(col)
</code></pre><p>通过设置<code>hive.map.aggr</code>值为<code>true</code>提高聚合的性能。如:</p>
<pre><code>hive&gt; SET hive.map.aggr=true;

hive&gt; SELECT count(*), avg(salary) FROM employees;
</code></pre><ul>
<li>表生成函数</li>
</ul>
<pre><code>hive&gt; SELECT explode(subordinates) AS sub FROM employees;
Mary Smith
Todd Jones
Bill King
</code></pre><pre><code>N rows        explode(array)                
N rows        explode(map)                
tuple        json_tuple(jsonStr, p1, p2, …,pn)    
tuple        parse_url_tuple(url, partname1, partname2, …, partnameN) where N &gt;= 1    
N ows        stack(n, col1, …, colM)
</code></pre><pre><code>SELECT parse_url_tuple(url, &#39;HOST&#39;, &#39;PATH&#39;, &#39;QUERY&#39;) as (host, path, query)
FROM url_table;
</code></pre><ul>
<li>其他内置函数</li>
</ul>
<pre><code>BOOLEAN        test in(val1, val2, …)
INT        length(s) 
STRING        reverse(s)
STRING        concat(s1, s2, …)
STRING        concat_ws(separator, s1, s2,…)
STRING        substr(s, start_index)
STRING        substr(s, int start, int length)
STRING        upper(s)
STRING        ucase(s)
STRING        lower(s)
STRING        lcase(s)
STRING        trim(s)
STRING        ltrim(s)
STRING        rtrim(s)
STRING        regexp_replace(s, regex,replacement)
STRING        regexp_extract(subject,regex_pattern, index)
STRING        parse_url(url, partname, key)
int        size(map&lt;K.V&gt;)
int        size(array&lt;T&gt;)
value of type    cast(&lt;expr&gt; as &lt;type&gt;)
STRING        from_unixtime(int unixtime)
STRING        to_date(timestamp)
INT        year(timestamp)
INT        month(timestamp)
INT        day(timestamp)
STRING        get_json_object(json_string,path)
STRING        space(n)
STRING        repeat(s, n)
STRING        ascii(s)
STRING        lpad(s, len, pad)
STRING        rpad(s, len, pad)
ARRAY&lt;STRING&gt;    split(s, pattern)
INT        find_in_set(s, commaSeparated String)
INT        locate(substr, str, pos])
INT        instr(str, substr)
MAP&lt;STRING,STRING&gt;    str_to_map(s, delim1, delim2)
ARRAY&lt;ARRAY&lt;STRING&gt;&gt;    sentences(s, lang, locale)
ARRAY&lt;STRUCT&lt;STRING,DOUBLE&gt;&gt;    ngrams(array&lt;array&lt;string&gt;&gt;,N, K, pf)
ARRAY&lt;STRUCT&lt;STRING,DOUBLE&gt;&gt;    context_ngrams(array&lt;array&lt;string&gt;&gt;,array&lt;string&gt;,int K, int pf)
BOOLEAN        in_file(s, filename)
</code></pre><h3 id="6-1-5-limit-">6.1.5 limit语句</h3>
<pre><code>hive&gt; SELECT upper(name), salary, deductions[&quot;Federal Taxes&quot;],
&gt; round(salary * (1 - deductions[&quot;Federal Taxes&quot;])) FROM employees
&gt; LIMIT 2;
JOHN DOE 100000.0 0.2 80000
MARY SMITH 80000.0 0.2 64000
</code></pre><p>使用<code>limit</code>来限制返回行数。</p>
<h3 id="6-1-6-">6.1.6 列别名</h3>
<pre><code>hive&gt; SELECT upper(name), salary, deductions[&quot;Federal Taxes&quot;] as fed_taxes,
&gt; round(salary * (1 - deductions[&quot;Federal Taxes&quot;])) as salary_minus_fed_taxes
&gt; FROM employees LIMIT 2;
JOHN DOE 100000.0 0.2 80000
MARY SMITH 80000.0 0.2 64000
</code></pre><h3 id="6-1-7-select-">6.1.7 嵌套select语句</h3>
<pre><code>hive&gt; FROM (
&gt; SELECT upper(name), salary, deductions[&quot;Federal Taxes&quot;] as fed_taxes,
&gt; round(salary * (1 - deductions[&quot;Federal Taxes&quot;])) as salary_minus_fed_taxes
&gt; FROM employees
&gt; ) e
&gt; SELECT e.name, e.salary_minus_fed_taxes
&gt; WHERE e.salary_minus_fed_taxes &gt; 70000;
JOHN DOE 100000.0 0.2 80000
</code></pre><h3 id="6-1-8-case-when-then-">6.1.8 case...when...then 句式</h3>
<p><code>CASE … WHEN … THEN</code>和<code>IF</code>语句类似,用于处理单个列的查询结果。如:</p>
<pre><code>hive&gt; SELECT name, salary,
&gt; CASE
&gt; WHEN salary &lt; 50000.0 THEN &#39;low&#39;
&gt; WHEN salary &gt;= 50000.0 AND salary &lt; 70000.0 THEN &#39;middle&#39;
&gt; WHEN salary &gt;= 70000.0 AND salary &lt; 100000.0 THEN &#39;high&#39;
&gt; ELSE &#39;very high&#39;
&gt; END AS bracket FROM employees;
John Doe 100000.0 very high
Mary Smith 80000.0 high
Todd Jones 70000.0 high
Bill King 60000.0 middle
Boss Man 200000.0 very high
Fred Finance 150000.0 very high
Stacy Accountant 60000.0 middle
</code></pre><h3 id="6-1-9-hive-mapreduce">6.1.9 什么情况下hive可以避免进行mapreduce</h3>
<p>在Hive中下面的查询不会触发<code>MapReduce</code></p>
<pre><code>SELECT * FROM employees;
</code></pre><p>对于<code>WHERE</code>子句中过滤条件只是分区字段这种情况，也无需<code>MapReduce</code></p>
<pre><code>SELECT * FROM employees
WHERE country = &#39;US&#39; AND state = &#39;CA&#39;
LIMIT 100;
</code></pre><p>若<code>hive.exec.mode.local.auto</code>属性为<code>true</code>的话Hive会尝试以本地模式运行。</p>
<pre><code>set hive.exec.mode.local.auto=true;
</code></pre><p>否则Hive使用<code>MapReduce</code>来执行。</p>
<p>最好将<code>set hive.exec.mode.local.auto=true;</code>这个设置添加到<code>$HOME/.hiverc</code>文件中。</p>
<h2 id="6-2-where-">6.2 where语句</h2>
<pre><code>SELECT * FROM employees
WHERE country = &#39;US&#39; AND state = &#39;CA&#39;;
</code></pre><pre><code>hive&gt; SELECT name, salary, deductions[&quot;Federal Taxes&quot;],
&gt; salary * (1 - deductions[&quot;Federal Taxes&quot;])
&gt; FROM employees
&gt; WHERE round(salary * (1 - deductions[&quot;Federal Taxes&quot;])) &gt; 70000;
John Doe 100000.0 0.2 80000.0
</code></pre><pre><code>hive&gt; SELECT name, salary, deductions[&quot;Federal Taxes&quot;],
&gt; salary * (1 - deductions[&quot;Federal Taxes&quot;]) as salary_minus_fed_taxes
&gt; FROM employees
&gt; WHERE round(salary_minus_fed_taxes) &gt; 70000;
FAILED: Error in semantic analysis: Line 4:13 Invalid table alias or
column reference &#39;salary_minus_fed_taxes&#39;: (possible column names are:
name, salary, subordinates, deductions, address)
</code></pre><p>不能在<code>WHERE</code>语句中使用列别名。可以使用嵌套<code>SELECT</code></p>
<pre><code>hive&gt; SELECT e.* FROM
&gt; (SELECT name, salary, deductions[&quot;Federal Taxes&quot;] as ded,
&gt; salary * (1 - deductions[&quot;Federal Taxes&quot;]) as salary_minus_fed_taxes
&gt; FROM employees) e
&gt; WHERE round(e.salary_minus_fed_taxes) &gt; 70000;
John Doe 100000.0 0.2 80000.0
Boss Man 200000.0 0.3 140000.0
Fred Finance 150000.0 0.3 105000.0
</code></pre><h3 id="6-2-1-">6.2.1 谓词操作符</h3>
<h3 id="6-2-2-">6.2.2 关于浮点数比较</h3>
<h3 id="6-2-3-like-rlike">6.2.3 like和rlike</h3>
<p>LIKE</p>
<pre><code>hive&gt; SELECT name, address.street FROM employees WHERE address.street LIKE &#39;%Ave.&#39;;
John Doe 1 Michigan Ave.
Todd Jones 200 Chicago Ave.

hive&gt; SELECT name, address.city FROM employees WHERE address.city LIKE &#39;O%&#39;;
Todd Jones Oak Park
Bill King Obscuria

hive&gt; SELECT name, address.street FROM employees WHERE address.street LIKE &#39;%Chi%&#39;;
Todd Jones 200 Chicago Ave.
</code></pre><p>RLIKE 通常后面跟正则表达式</p>
<pre><code>hive&gt; SELECT name, address.street
&gt; FROM employees WHERE address.street RLIKE &#39;.*(Chicago|Ontario).*&#39;;
Mary Smith 100 Ontario St.
Todd Jones 200 Chicago Ave.
</code></pre><h2 id="6-3-group-by-">6.3 group by 语句</h2>
<p><code>GROUP BY</code>通常与聚合函数一起使用。按一个或多个结果进行分组。</p>
<pre><code>hive&gt; SELECT year(ymd), avg(price_close) FROM stocks
&gt; WHERE exchange = &#39;NASDAQ&#39; AND symbol = &#39;AAPL&#39;
&gt; GROUP BY year(ymd);
1984 25.578625440597534
1985 20.193676221040867
1986 32.46102808021274
1987 53.88968399108163
1988 41.540079275138766
1989 41.65976212516664
1990 37.56268799823263
1991 52.49553383386182
1992 54.80338610251119
1993 41.02671956450572
1994 34.0813495847914
</code></pre><p><code>HAVING</code>语句,跟<code>GROUP BY</code>一起使用,用来对分组条件过滤。</p>
<pre><code>hive&gt; SELECT year(ymd), avg(price_close) FROM stocks
&gt; WHERE exchange = &#39;NASDAQ&#39; AND symbol = &#39;AAPL&#39;
&gt; GROUP BY year(ymd)
&gt; HAVING avg(price_close) &gt; 50.0;
1987 53.88968399108163
1991 52.49553383386182
1992 54.80338610251119
1999 57.77071460844979
2000 71.74892876261757
2005 52.401745992993554
</code></pre><p>若没有<code>HAVING</code>,使用嵌套的<code>SELECT</code>来查询</p>
<pre><code>hive&gt; SELECT s2.year, s2.avg FROM
&gt; (SELECT year(ymd) AS year, avg(price_close) AS avg FROM stocks
&gt; WHERE exchange = &#39;NASDAQ&#39; AND symbol = &#39;AAPL&#39;
&gt; GROUP BY year(ymd)) s2
&gt; WHERE s2.avg &gt; 50.0;
1987 53.88968399108163
</code></pre><h2 id="6-4-join-">6.4 join语句</h2>
<h3 id="6-4-1-inner-join">6.4.1 inner join</h3>
<p>取连接的两个表中都存在与连接标准匹配的数据。</p>
<pre><code>hive&gt; SELECT a.ymd, a.price_close, b.price_close
&gt; FROM stocks a JOIN stocks b ON a.ymd = b.ymd
&gt; WHERE a.symbol = &#39;AAPL&#39; AND b.symbol = &#39;IBM&#39;;
2010-01-04 214.01 132.45
2010-01-05 214.38 130.85
2010-01-06 210.97 130.0
2010-01-07 210.58 129.55
2010-01-08 211.98 130.85
2010-01-11 210.11 129.48
</code></pre><p>Hive中不支持下面这样的查询语法</p>
<pre><code>SELECT a.ymd, a.price_close, b.price_close
FROM stocks a JOIN stocks b
ON a.ymd &lt;= b.ymd
WHERE a.symbol = &#39;AAPL&#39; AND b.symbol = &#39;IBM&#39;;
</code></pre><p>Hive不支持<code>ON</code>子句中使用<code>OR</code>.</p>
<h3 id="6-4-2-join-">6.4.2 join优化</h3>
<h3 id="6-4-3-left-outer-join">6.4.3 left outer join</h3>
<p>左外连接(<code>LEFT OUTER JOIN</code>)左边符合<code>WHERE</code>条件的语句会返回,右表中匹配不到的字段值用<code>NULL</code>代替.</p>
<pre><code>hive&gt; SELECT s.ymd, s.symbol, s.price_close, d.dividend
&gt; FROM stocks s LEFT OUTER JOIN dividends d ON s.ymd = d.ymd AND s.symbol = d.symbol
&gt; WHERE s.symbol = &#39;AAPL&#39;;
1987-05-01 AAPL 80.0 NULL
1987-05-04 AAPL 79.75 NULL
1987-05-05 AAPL 80.25 NULL
1987-05-06 AAPL 80.0 NULL
1987-05-07 AAPL 80.25 NULL
1987-05-08 AAPL 79.0 NULL
1987-05-11 AAPL 77.0 0.015
1987-05-12 AAPL 75.5 NULL
1987-05-13 AAPL 78.5 NULL
1987-05-14 AAPL 79.25 NULL
1987-05-15 AAPL 78.25 NULL
1987-05-18 AAPL 75.75 NULL
1987-05-19 AAPL 73.25 NULL
1987-05-20 AAPL 74.5 NULL
</code></pre><h3 id="6-4-4-outer-join">6.4.4 outer join</h3>
<p>对于外连接(<code>OUTER JOIN</code>)会忽略掉分区过滤条件,对于内链接(<code>INNER JOIN</code>)则不会忽略掉过滤条件.</p>
<pre><code>hive&gt; SELECT s.ymd, s.symbol, s.price_close, d.dividend
&gt; FROM stocks s LEFT OUTER JOIN dividends d ON s.ymd = d.ymd AND s.symbol = d.symbol
&gt; WHERE s.symbol = &#39;AAPL&#39;
&gt; AND s.exchange = &#39;NASDAQ&#39; AND d.exchange = &#39;NASDAQ&#39;;
1987-05-11 AAPL 77.0 0.015
1987-08-10 AAPL 48.25 0.015
1987-11-17 AAPL 35.0 0.02
1988-02-12 AAPL 41.0 0.02
1988-05-16 AAPL 41.25 0.02
</code></pre><h3 id="6-4-5-right-outer-join">6.4.5 right outer join</h3>
<p>右外连接(<code>RIGHT OUTER JOIN</code>)返回右边表符合<code>WHERE</code>语句的记录.左表中匹配不到的字段值用<code>NULL</code>代替.</p>
<pre><code>hive&gt; SELECT s.ymd, s.symbol, s.price_close, d.dividend
&gt; FROM dividends d RIGHT OUTER JOIN stocks s ON d.ymd = s.ymd AND d.symbol = s.symbol
&gt; WHERE s.symbol = &#39;AAPL&#39;;
1987-05-07 AAPL 80.25 NULL
1987-05-08 AAPL 79.0 NULL
1987-05-11 AAPL 77.0 0.015
1987-05-12 AAPL 75.5 NULL
1987-05-13 AAPL 78.5 NULL
</code></pre><h3 id="6-4-6-full-outer-join">6.4.6 full outer join</h3>
<p>完全外连接(<code>FULL OUTER JOIN</code>)返回所有表中符合<code>WHERE</code>语句条件的所有记录.</p>
<pre><code>hive&gt; SELECT s.ymd, s.symbol, s.price_close, d.dividend
&gt; FROM dividends d FULL OUTER JOIN stocks s ON d.ymd = s.ymd AND d.symbol = s.symbol
&gt; WHERE s.symbol = &#39;AAPL&#39;;
1987-05-07 AAPL 80.25 NULL
1987-05-08 AAPL 79.0 NULL
1987-05-11 AAPL 77.0 0.015
1987-05-12 AAPL 75.5 NULL
1987-05-13 AAPL 78.5 NULL
</code></pre><h3 id="6-4-7-left-semi-join">6.4.7 left semi-join</h3>
<p>左半开连接(<code>LEFT SEMI JOIN</code>)，在满足右边表中<code>ON</code>语句的条件判定的前提下,返回左边表中的记录。</p>
<p>Hive中不支持的查询</p>
<pre><code>SELECT s.ymd, s.symbol, s.price_close FROM stocks s
WHERE s.ymd, s.symbol IN
(SELECT d.ymd, d.symbol FROM dividends d);
</code></pre><p>用下面的查询来代替</p>
<pre><code>hive&gt; SELECT s.ymd, s.symbol, s.price_close
&gt; FROM stocks s LEFT SEMI JOIN dividends d ON s.ymd = d.ymd AND s.symbol = d.symbol;
1962-11-05 IBM 361.5
1962-08-07 IBM 373.25
1962-05-08 IBM 459.5
1962-02-06 IBM 551.5
</code></pre><p>注意:<code>SELECT</code>和<code>WHERE</code>语句中不能引用到右边表中的字段.Hive不支持右半开连接.</p>
<h3 id="6-4-8-join">6.4.8 笛卡尔积join</h3>
<p>笛卡尔积，返回左边表中的行数乘以右边表中的行数。</p>
<pre><code>SELECTS * FROM stocks JOIN dividends;
</code></pre><h3 id="6-4-9-map-side-join">6.4.9 map-side join</h3>
<h2 id="6-5-order-by-sort-by">6.5 order by和sort by</h2>
<p>在Hive中提供<code>ORDER BY</code>和<code>SORT BY</code>来对数据进行排序。其区别是:</p>
<ul>
<li><p><code>ORDER BY</code>用来对结果进行全局排序</p>
</li>
<li><p><code>SORT BY</code>只会在每个<code>reducer</code>中对数据排序。是局部排序。只保证每个<code>reducer</code>的输出是有序的。</p>
</li>
</ul>
<p><code>ORDER BY</code>是全局排序。运行时间会较长。若属性<code>hive.mapred.mode</code>的值是<code>strict</code>，Hive要求必须使用<code>LIMIT</code>限制输出.默认是<code>nonstrict</code>。</p>
<ul>
<li>ORDER BY</li>
</ul>
<pre><code>SELECT s.ymd, s.symbol, s.price_close
FROM stocks s
ORDER BY s.ymd ASC, s.symbol DESC;
</code></pre><ul>
<li>SORT BY</li>
</ul>
<pre><code>SELECT s.ymd, s.symbol, s.price_close
FROM stocks s
SORT BY s.ymd ASC, s.symbol DESC;
</code></pre><h2 id="6-6-sort-by-distribute-by">6.6 含有sort by 的distribute by</h2>
<p><code>DISTRIBUTE BY</code>控制<code>map</code>的输出在<code>reducer</code>中是如何划分的。<code>MapReduce</code>中传输的所有数据都是键值对。默认情况下，<code>MapReduce</code>计算框架依据<code>map</code>输入的键计算其哈希值，然后按得到的哈希值将键值分发到多个<code>reducer</code>中。
<code>DISTRIBUTE BY</code>和<code>GROUP BY</code>在其控制着<code>reducer</code>是如何接受一行行数据进行处理这方面是类似的。而<code>SORT BY</code>控制着<code>reducer</code>内的数据是如何排序的。
<code>DISTRIBUTE BY</code>语句位于<code>SORT BY</code>语句之前。</p>
<pre><code>hive&gt; SELECT s.ymd, s.symbol, s.price_close
&gt; FROM stocks s
&gt; DISTRIBUTE BY s.symbol
&gt; SORT BY s.symbol ASC, s.ymd ASC;
1984-09-07 AAPL 26.5
1984-09-10 AAPL 26.37
1984-09-11 AAPL 26.87
1984-09-12 AAPL 26.12
1984-09-13 AAPL 27.5
1984-09-14 AAPL 27.87
1984-09-17 AAPL 28.62
1984-09-18 AAPL 27.62
1984-09-19 AAPL 27.0
1984-09-20 AAPL 27.12
</code></pre><h2 id="6-7-cluster-by">6.7 cluster by</h2>
<pre><code>hive&gt; SELECT s.ymd, s.symbol, s.price_close
&gt; FROM stocks s
&gt; CLUSTER BY s.symbol;
2010-02-08 AAPL 194.12
2010-02-05 AAPL 195.46
2010-02-04 AAPL 192.05
2010-02-03 AAPL 199.23
2010-02-02 AAPL 195.86
2010-02-01 AAPL 194.73
2010-01-29 AAPL 192.06
2010-01-28 AAPL 199.29
2010-01-27 AAPL 207.88
</code></pre><h2 id="6-8-">6.8 类型转换</h2>
<p>Hive使用<code>cast</code>进行数据类型转换。</p>
<pre><code>SELECT name, salary FROM employees
WHERE cast(salary AS FLOAT) &lt; 100000.0;
</code></pre><p>若<code>cast</code>中的数据类型不合法为返回为<code>NULL</code>。</p>
<p>需要注意的是将浮点数转化为整形推荐使用<code>round()</code> 或 <code>floor()</code>。</p>
<p>类型转换<code>BINARY</code>值</p>
<pre><code>SELECT (2.0*cast(cast(b as string) as double)) from src;
</code></pre><h2 id="6-9-">6.9 抽样查询</h2>
<p>使用<code>rand()</code>函数进行抽样。</p>
<pre><code>hive&gt; SELECT * from numbers TABLESAMPLE(BUCKET 3 OUT OF 10 ON rand()) s;
2
4

hive&gt; SELECT * from numbers TABLESAMPLE(BUCKET 3 OUT OF 10 ON rand()) s;
7
10
</code></pre><pre><code>hive&gt; SELECT * from numbers TABLESAMPLE(BUCKET 3 OUT OF 10 ON number) s;
2

hive&gt; SELECT * from numbers TABLESAMPLE(BUCKET 5 OUT OF 10 ON number) s;
4

hive&gt; SELECT * from numbers TABLESAMPLE(BUCKET 3 OUT OF 10 ON number) s;
2
</code></pre><h3 id="6-9-1-">6.9.1 数据块抽样</h3>
<p>基于百分比的数据抽样</p>
<pre><code>hive&gt; SELECT * FROM numbersflat TABLESAMPLE(0.1 PERCENT) s;
</code></pre><h3 id="6-9-2-">6.9.2 分桶表的输入裁剪</h3>
<h2 id="6-10-union-all">6.10 union all</h2>
<p><code>UNION ALL</code>将两个或多个表进行合并。每一个<code>union</code>子查询都必须具有相同的列。且对应的每个字段类型必须一致。</p>
<pre><code>SELECT log.ymd, log.level, log.message
FROM (
  SELECT l1.ymd, l1.level,
     l1.message, &#39;Log1&#39; AS source
  FROM log1 l1
UNION ALL
  SELECT l2.ymd, l2.level,
     l2.message, &#39;Log2&#39; AS source
FROM log1 l2
) log
SORT BY log.ymd ASC;
</code></pre><p>使用<code>UNION</code>对同一个源表的数据进行合并。如:</p>
<pre><code>FROM (
FROM src SELECT src.key, src.value WHERE src.key &lt; 100
UNION ALL
FROM src SELECT src.* WHERE src.key &gt; 110
) unioninput
INSERT OVERWRITE DIRECTORY &#39;/tmp/union.out&#39; SELECT unioninput.*
</code></pre>
                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../chapter-5/0.html" class="navigation navigation-prev " aria-label="Previous page: 第五章 HiveQL:数据操作"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../chapter-7/0.html" class="navigation navigation-next " aria-label="Next page: 第七章 HiveQL:视图"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-javascript.js"></script>
        <script src="..\gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
        <script src="..\gitbook/app.js"></script>
        

    
    <script src="..\gitbook/plugins/gitbook-plugin-mixpanel/plugin.js"></script>
    

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="..\gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

    
    <script src="..\gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
